# Детальный план реализации настройки формы компонентов (Бэкенд)

## Задача 1: Создание модели данных для хранения конфигурации формы

**Описание:** Создать модель базы данных для хранения конфигурации формы компонентов с составным ключом `post_type_slug` + `blueprint_id`.

**Действия:**

- Создать миграцию для новой таблицы `form_configs`
- Поля таблицы:
  - `id` (PRIMARY KEY, AUTO_INCREMENT)
  - `post_type_slug` (VARCHAR, NOT NULL) - slug типа контента
  - `blueprint_id` (INT, NOT NULL, FOREIGN KEY -> blueprints.id) - ID blueprint
  - `config_json` (JSON, NOT NULL) - JSON с конфигурацией компонентов (ключ - путь к узлу, значение - ZEditComponent)
  - `created_at` (TIMESTAMP, DEFAULT CURRENT_TIMESTAMP)
  - `updated_at` (TIMESTAMP, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP)
  - UNIQUE KEY на (`post_type_slug`, `blueprint_id`)
- Добавить индекс на `post_type_slug` для быстрого поиска
- Добавить индекс на `blueprint_id` для быстрого поиска
- Создать модель/класс в ORM (например, SQLAlchemy для Python, Eloquent для Laravel)

**Файлы для создания:**

- Миграция базы данных: `YYYY_MM_DD_HHMMSS_create_form_configs_table.sql` или соответствующий файл миграции
- Модель: `app/models/FormConfig.php` (Laravel) или `models/form_config.py` (Python/Django)

**Зависимости:** Нет

---

## Задача 2: Создание Zod/Pydantic схем для валидации конфигурации формы

**Описание:** Создать схемы валидации для конфигурации формы компонентов на бэкенде, соответствующие фронтенд схемам.

**Действия:**

- Создать схемы валидации, соответствующие `ZEditComponent` из фронтенда:
  - `EditInputText` - для компонента `inputText`
  - `EditInputNumber` - для компонента `inputNumber`
  - `EditComponent` - discriminated union всех типов компонентов
- Создать схему для всей конфигурации:
  - `FormConfigPayload` - объект с ключами (путь к узлу) и значениями (`EditComponent`)
- Создать схемы для API запросов:
  - `GetFormConfigResponse` - ответ при получении конфигурации
  - `SaveFormConfigRequest` - запрос на сохранение конфигурации
  - `SaveFormConfigResponse` - ответ при сохранении конфигурации
- Использовать те же правила валидации, что и на фронтенде

**Файлы для создания:**

- `app/schemas/form_config.py` (Python/Pydantic) или `app/Requests/FormConfigRequest.php` (Laravel)

**Зависимости:** Задача 1

---

## Задача 3: Создание эндпоинта GET для получения конфигурации формы

**Описание:** Создать API эндпоинт для получения конфигурации формы компонентов по составному ключу `post_type_slug` + `blueprint_id`.

**Действия:**

- Создать эндпоинт: `GET /api/v1/admin/post-types/{post_type_slug}/form-config/{blueprint_id}`
- Параметры:
  - `post_type_slug` (path parameter) - slug типа контента
  - `blueprint_id` (path parameter) - ID blueprint
- Логика:
  - Проверить существование типа контента по slug
  - Проверить существование blueprint по ID
  - Проверить, что blueprint привязан к типу контента (опционально, для валидации)
  - Найти конфигурацию в БД по составному ключу
  - Если конфигурация не найдена, вернуть пустой объект `{}` со статусом 200
  - Если найдена, вернуть `config_json` из БД
- Валидация:
  - Проверить, что `post_type_slug` существует
  - Проверить, что `blueprint_id` существует и является числом
- Обработка ошибок:
  - 404 если тип контента не найден
  - 404 если blueprint не найден
  - 500 при ошибках БД

**Файлы для создания/изменения:**

- Контроллер: `app/controllers/FormConfigController.php` или `app/api/v1/admin/form_config.py`
- Роутинг: добавить маршрут в файл роутов

**Зависимости:** Задача 1, Задача 2

---

## Задача 4: Создание эндпоинта POST/PUT для сохранения конфигурации формы

**Описание:** Создать API эндпоинт для сохранения или обновления конфигурации формы компонентов.

**Действия:**

- Создать эндпоинт: `PUT /api/v1/admin/post-types/{post_type_slug}/form-config/{blueprint_id}`
  - Альтернативно: `POST` для создания, `PUT` для обновления (или использовать один `PUT` для upsert)
- Параметры:
  - `post_type_slug` (path parameter) - slug типа контента
  - `blueprint_id` (path parameter) - ID blueprint
  - Body: JSON объект с конфигурацией (ключ - путь к узлу, значение - `EditComponent`)
- Логика:
  - Валидировать входные данные через схемы из Задачи 2
  - Проверить существование типа контента и blueprint
  - Проверить, что все пути к узлам в конфигурации соответствуют схеме blueprint (опционально, для валидации)
  - Выполнить upsert (insert или update) в таблицу `form_configs`
  - Если запись существует - обновить `config_json` и `updated_at`
  - Если не существует - создать новую запись
- Валидация:
  - Валидировать структуру JSON конфигурации
  - Валидировать каждый компонент через `EditComponent` схему
  - Проверить, что пути к узлам валидны (не пустые строки)
- Обработка ошибок:
  - 400 при ошибках валидации
  - 404 если тип контента или blueprint не найдены
  - 500 при ошибках БД
- Возвращать сохранённую конфигурацию в ответе

**Файлы для создания/изменения:**

- Контроллер: добавить метод в `FormConfigController`
- Сервис: `app/services/FormConfigService.php` (опционально, для бизнес-логики)

**Зависимости:** Задача 1, Задача 2, Задача 3

---

## Задача 5: Валидация соответствия конфигурации схеме blueprint

**Описание:** Реализовать валидацию, что все пути к узлам в конфигурации формы соответствуют реальной схеме blueprint.

**Действия:**

- Создать функцию валидации:
  - Принимает схему blueprint и конфигурацию формы
  - Проверяет, что все ключи (пути к узлам) в конфигурации существуют в схеме blueprint
  - Проверяет, что тип данных узла соответствует типу компонента (через `getAllowedComponents`)
  - Проверяет, что кардинальность узла соответствует типу компонента
- Интегрировать валидацию в эндпоинт сохранения (Задача 4)
- При ошибках валидации возвращать:
  - Статус 422 (Unprocessable Entity)
  - Список ошибок с указанием невалидных путей и причин
- Опционально: предупреждать о путях, которые есть в схеме, но отсутствуют в конфигурации

**Файлы для создания:**

- Валидатор: `app/validators/FormConfigValidator.php` или `app/validators/form_config_validator.py`
- Интеграция в контроллер из Задачи 4

**Зависимости:** Задача 2, Задача 4

---

## Задача 6: Создание эндпоинта для удаления конфигурации формы

**Описание:** Создать API эндпоинт для удаления конфигурации формы (опциональная функциональность).

**Действия:**

- Создать эндпоинт: `DELETE /api/v1/admin/post-types/{post_type_slug}/form-config/{blueprint_id}`
- Параметры:
  - `post_type_slug` (path parameter) - slug типа контента
  - `blueprint_id` (path parameter) - ID blueprint
- Логика:
  - Найти конфигурацию по составному ключу
  - Если найдена - удалить из БД
  - Если не найдена - вернуть 404 или 204 (No Content) в зависимости от требований
- Обработка ошибок:
  - 404 если конфигурация не найдена
  - 500 при ошибках БД
- Возвращать статус 204 (No Content) при успешном удалении

**Файлы для создания/изменения:**

- Контроллер: добавить метод удаления в `FormConfigController`

**Зависимости:** Задача 1, Задача 3

---

## Задача 7: Реализация каскадного удаления при удалении типа контента или blueprint

**Описание:** Настроить каскадное удаление конфигураций формы при удалении связанного типа контента или blueprint.

**Действия:**

- При удалении типа контента:
  - Найти все конфигурации формы с `post_type_slug = удаляемый_slug`
  - Удалить все найденные конфигурации
  - Или настроить CASCADE DELETE на уровне БД (если используется внешний ключ)
- При удалении blueprint:
  - Найти все конфигурации формы с `blueprint_id = удаляемый_id`
  - Удалить все найденные конфигурации
  - Или настроить CASCADE DELETE на уровне БД
- Реализовать в:
  - Методе удаления типа контента
  - Методе удаления blueprint
  - Или через триггеры БД / события модели

**Файлы для изменения:**

- Контроллер удаления типа контента
- Контроллер удаления blueprint
- Или настройка CASCADE в миграции БД

**Зависимости:** Задача 1

---

## Задача 8: Добавление эндпоинта для получения списка конфигураций по типу контента

**Описание:** Создать эндпоинт для получения всех конфигураций формы для конкретного типа контента (полезно для администрирования).

**Действия:**

- Создать эндпоинт: `GET /api/v1/admin/post-types/{post_type_slug}/form-configs`
- Параметры:
  - `post_type_slug` (path parameter) - slug типа контента
- Логика:
  - Найти все конфигурации формы с указанным `post_type_slug`
  - Вернуть список конфигураций с информацией о blueprint (ID, название)
- Ответ должен содержать:
  - Массив объектов с полями: `blueprint_id`, `blueprint_name` (опционально), `config_json`, `created_at`, `updated_at`
- Обработка ошибок:
  - 404 если тип контента не найден
  - 500 при ошибках БД

**Файлы для создания/изменения:**

- Контроллер: добавить метод в `FormConfigController`

**Зависимости:** Задача 1, Задача 3

---

## Задача 9: Добавление логирования операций с конфигурацией формы

**Описание:** Реализовать логирование всех операций создания, обновления и удаления конфигураций формы для аудита.

**Действия:**

- Добавить логирование в методы:
  - Создания конфигурации (POST/PUT)
  - Обновления конфигурации (PUT)
  - Удаления конфигурации (DELETE)
- Логировать:
  - Действие (create/update/delete)
  - `post_type_slug` и `blueprint_id`
  - ID пользователя, выполнившего действие (если есть система авторизации)
  - Timestamp
  - Размер конфигурации (количество узлов)
- Использовать стандартный механизм логирования приложения
- Уровень логирования: INFO для успешных операций, ERROR для ошибок

**Файлы для изменения:**

- Контроллер: добавить логирование в методы `FormConfigController`
- Или использовать middleware/события для автоматического логирования

**Зависимости:** Задача 3, Задача 4, Задача 6

---

## Задача 10: Написание тестов для API эндпоинтов конфигурации формы

**Описание:** Создать unit и integration тесты для всех API эндпоинтов работы с конфигурацией формы.

**Действия:**

- Создать тесты для:
  - GET конфигурации (существующая и несуществующая)
  - PUT сохранения конфигурации (создание новой и обновление существующей)
  - DELETE удаления конфигурации
  - Валидации входных данных
  - Валидации соответствия схеме blueprint
  - Каскадного удаления
- Тестовые сценарии:
  - Успешное получение конфигурации
  - Получение несуществующей конфигурации (должна вернуть пустой объект)
  - Создание новой конфигурации
  - Обновление существующей конфигурации
  - Удаление конфигурации
  - Валидация невалидных данных (неправильная структура компонента)
  - Валидация несуществующих путей к узлам
  - Проверка каскадного удаления
- Использовать тестовую БД и фикстуры
- Покрыть edge cases и ошибки

**Файлы для создания:**

- `tests/FormConfigControllerTest.php` или `tests/test_form_config.py`
- Фикстуры для тестовых данных

**Зависимости:** Задача 3, Задача 4, Задача 5, Задача 6

---

## Дополнительные замечания

- Использовать транзакции БД для операций создания/обновления конфигурации
- Рассмотреть возможность кэширования конфигураций формы (Redis/Memcached) для улучшения производительности
- Добавить rate limiting для API эндпоинтов, если требуется
- Документировать API эндпоинты (Swagger/OpenAPI)
- Убедиться, что все операции требуют авторизации администратора
- Рассмотреть возможность версионирования конфигураций (опционально, для истории изменений)
